<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>School Data Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; }
        .header { padding: 15px 30px; display: flex; align-items: center; }
        .header-title { font-size: 1.5em; font-weight: 700; background: linear-gradient(90deg, #FF5F5F, #FF9116); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .header-logo { height: 90px; margin-right: 15px; }
        .container { padding: 2em; }
        h2 { color: #ffffff; font-weight: 500; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .card { background-color: #1e1e1e; border-radius: 8px; padding: 1.5em; margin-top: 1.5em; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        label { font-weight: 500; color: #bbbbbb; font-size: 1.1em; display: block; margin-bottom: 8px; }
        select, .config-input { width: 100%; padding: 12px; margin-top: 10px; background-color: #333; color: #e0e0e0; border: 1px solid #555; border-radius: 6px; font-size: 1em; box-sizing: border-box; }
        .button-container { display: flex; justify-content: center; margin-top: 2em; position: relative; }
        .submit-btn { padding: 15px 30px; background: linear-gradient(90deg, #FF5F5F, #FF9116); color: white; border: none; border-radius: 6px; font-size: 1.2em; font-weight: 500; cursor: pointer; transition: opacity 0.3s ease; }
        .submit-btn:hover { opacity: 0.9; }
        .submit-btn:disabled { cursor: not-allowed; opacity: 0.5; }
        .loader { border: 5px solid #333; border-top: 5px solid #FF5F5F; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 50%; margin-top: -25px; margin-left: -25px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Checkbox styles */
        #school-checkbox-container {
            max-height: 200px;
            overflow-y: auto;
            background-color: #2a2a2a;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-item label {
            margin-bottom: 0;
            font-weight: 400;
            cursor: pointer;
            flex: 1;
        }

        /* Table styles */
        .school-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .school-details-table th, .school-details-table td {
            border: 1px solid #444;
            padding: 10px;
            text-align: left;
        }
        .school-details-table th {
            background-color: #333;
            color: #fff;
        }
        .school-details-table tbody tr:nth-child(odd) {
            background-color: #2a2a2a;
        }
        .school-details-table tbody tr:nth-child(even) {
            background-color: #1e1e1e;
        }
        .school-details-table tfoot {
            font-weight: bold;
            background-color: #333;
        }
        .school-details-table tfoot td {
            color: #fff;
        }
    </style>
</head>
<body>

    <header class="header">
        <img src="{{ url_for('static', filename='assets/msg_logo.png') }}" alt="Logo" class="header-logo">
        <span class="header-title">School District Data Explorer - Music Science & Technology Group</span>
    </header>

    <div class="container">
        <form id="proposal-form" action="/proposal" method="POST">
            <div class="card">
                <h2>1. Select District & Schools</h2>
                <div>
                    <label for="district">District Name:</label>
                    <select id="district" name="district">
                        {% for district in districts %}
                            <option value="{{ district }}">{{ district }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="margin-top: 1em;">
                    <label>School Names (Select one or more):</label>
                    <div class="checkbox-item" style="border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="select-all-schools">
                        <label for="select-all-schools" style="font-weight: 500; color: #fff;">Select All Schools</label>
                    </div>
                    <div id="school-checkbox-container">
                        <!-- Checkboxes will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>2. Configure Program</h2>
                <div style="display: flex; gap: 20px;">
                    <div style="flex-grow: 1;">
                        <label for="weeks-input">Number of Weeks:</label>
                        <input type="number" id="weeks-input" name="num_weeks" class="config-input" value="30">
                    </div>
                    <div style="flex-grow: 1;">
                        <label for="days-input">Days per Week:</label>
                        <input type="number" id="days-input" name="days_per_week" class="config-input" value="2">
                    </div>
                </div>
                <div style="margin-top: 1em;">
                    <label for="total-students-input">Total Students in Selected Schools:</label>
                    <input type="text" id="total-students-input" class="config-input" readonly>
                </div>
            </div>

            <div class="card">
                <h2>3. Cost Summary</h2>
                <label for="cost-proposal-input">Total Estimated Cost:</label>
                <input type="text" id="cost-proposal-input" name="cost_proposal" class="config-input" readonly>
                <div style="margin-top: 1em;">
                    <label for="cost-per-student-input">Estimated Cost per Student:</label>
                    <input type="text" id="cost-per-student-input" class="config-input" readonly>
                </div>
            </div>

            <div class="card" id="school-funding-card" style="display: none;">
                <h2>4. Selected School Funding Details</h2>
                <table class="school-details-table">
                    <thead>
                        <tr>
                            <th>School Name</th>
                            <th>Total Enrollment</th>
                            <th>FRPM Percent (%)</th>
                            <th>Estimated Funding (USD)</th>
                        </tr>
                    </thead>
                    <tbody id="school-funding-body">
                        <!-- School funding details will be dynamically inserted here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="1">Total Students:</td>
                            <td id="total-enrollment-footer" colspan="3">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="button-container">
                <button type="submit" class="submit-btn" id="generate-btn">Generate AI Proposal</button>
                <div class="loader" id="loader"></div>
            </div>

            <!-- Hidden inputs to pass calculated values to the backend -->
            <input type="hidden" name="total_students_for_ai" id="total-students-for-ai-hidden">
            <input type="hidden" name="cost_per_student_for_ai" id="cost-per-student-for-ai-hidden">
        </form>
    </div>

<script>
    const allData = JSON.parse('{{ all_data|safe }}');
    const districtSelect = document.getElementById('district');
    const schoolCheckboxContainer = document.getElementById('school-checkbox-container');
    const selectAllSchoolsCheckbox = document.getElementById('select-all-schools'); // New
    const weeksInput = document.getElementById('weeks-input');
    const daysInput = document.getElementById('days-input');
    const totalStudentsInput = document.getElementById('total-students-input'); // New
    const costProposalInput = document.getElementById('cost-proposal-input');
    const costPerStudentInput = document.getElementById('cost-per-student-input'); // New
    const proposalForm = document.getElementById('proposal-form');
    const generateBtn = document.getElementById('generate-btn');
    const loader = document.getElementById('loader');
    const schoolFundingCard = document.getElementById('school-funding-card');
    const schoolFundingBody = document.getElementById('school-funding-body');
    const totalEnrollmentFooter = document.getElementById('total-enrollment-footer'); // New
    const totalStudentsForAiHidden = document.getElementById('total-students-for-ai-hidden'); // New hidden input
    const costPerStudentForAiHidden = document.getElementById('cost-per-student-for-ai-hidden'); // New hidden input


    // Cost per school per day based on user-provided formula
    // ($9450 / 7 weeks / 2 days / 2 schools) = $337.50
    const COST_PER_SCHOOL_DAY = 337.50;
    const PER_STUDENT_FUNDING = 2500; // Updated per-student amount

    function updateSchools() {
        const selectedDistrict = districtSelect.value;
        const schoolsInDistrict = allData.filter( row => row['District Name'] === selectedDistrict);

        schoolCheckboxContainer.innerHTML = ""; // Clear existing checkboxes
        
        // Reset "Select All" checkbox state
        selectAllSchoolsCheckbox.checked = false;

        schoolsInDistrict.forEach((school, index) => {
            const schoolName = school['School Name'];
            const checkboxId = `school-${index}`;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'checkbox-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'schoolname';
            checkbox.value = schoolName;
            checkbox.id = checkboxId;
            // Store all relevant school data on the checkbox itself
            checkbox.dataset.schoolData = JSON.stringify(school);
            // Add event listener to each checkbox to recalculate costs and update table on change
            checkbox.addEventListener('change', updateAllCostsAndDetails);

            const label = document.createElement('label');
            label.htmlFor = checkboxId;
            label.textContent = schoolName;

            itemDiv.appendChild(checkbox);
            itemDiv.appendChild(label);
            schoolCheckboxContainer.appendChild(itemDiv);
        });

        updateAllCostsAndDetails(); // Recalculate and show costs for the updated schools and table
    }

    function calculateFunding(schoolData) {
        const enrollment = parseInt(schoolData['Total Enrollment'], 10) || 0;
        const frpmPercent = parseFloat(schoolData['FRPM Percent (%)']) / 100 || 0;
        return (enrollment * frpmPercent * PER_STUDENT_FUNDING);
    }

    function updateAllCostsAndDetails() {
        const numWeeks = parseInt(weeksInput.value, 10) || 0;
        const daysPerWeek = parseInt(daysInput.value, 10) || 0;
        const checkedCheckboxes = document.querySelectorAll('input[name="schoolname"]:checked');
        const numSchools = checkedCheckboxes.length;

        let totalEnrollment = 0;
        let totalEstimatedFunding = 0;

        schoolFundingBody.innerHTML = ''; // Clear existing table data

        if (numSchools > 0) {
            schoolFundingCard.style.display = 'block'; // Show the card if schools are selected
            checkedCheckboxes.forEach(checkbox => {
                const schoolData = JSON.parse(checkbox.dataset.schoolData);
                const enrollment = parseInt(schoolData['Total Enrollment'], 10) || 0;
                const schoolFunding = calculateFunding(schoolData);

                totalEnrollment += enrollment;
                totalEstimatedFunding += schoolFunding;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${schoolData['School Name']}</td>
                    <td>${enrollment.toLocaleString()}</td>
                    <td>${(parseFloat(schoolData['FRPM Percent (%)'])).toFixed(2)}%</td>
                    <td>${schoolFunding.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                `;
                schoolFundingBody.appendChild(row);
            });
        } else {
            schoolFundingCard.style.display = 'none'; // Hide the card if no schools are selected
        }

        // Update Total Students in "Configure Program"
        totalStudentsInput.value = totalEnrollment.toLocaleString();
        totalEnrollmentFooter.textContent = totalEnrollment.toLocaleString();


        // Calculate Total Estimated Cost
        const totalProgramCost = numWeeks * daysPerWeek * numSchools * COST_PER_SCHOOL_DAY;
        costProposalInput.value = totalProgramCost.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

        // Calculate Cost per Student
        let costPerStudent = 0;
        if (totalEnrollment > 0) {
            costPerStudent = totalProgramCost / totalEnrollment;
        }
        costPerStudentInput.value = costPerStudent.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

        // Update hidden inputs for backend submission
        totalStudentsForAiHidden.value = totalEnrollment;
        costPerStudentForAiHidden.value = costPerStudent.toFixed(2); // Send as number string
    }

    // Event listener for "Select All Schools" checkbox
    selectAllSchoolsCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        const schoolCheckboxes = schoolCheckboxContainer.querySelectorAll('input[name="schoolname"]');
        schoolCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateAllCostsAndDetails(); // Update everything after toggling all schools
    });


    proposalForm.addEventListener('submit', function(event) {
        // Before submitting, remove currency formatting to send a clean number to the backend
        if (costProposalInput) {
            // Remove all non-digit and non-decimal characters, then parse as float
            const rawCost = costProposalInput.value.replace(/[^0-9.-]+/g,"");
            costProposalInput.value = parseFloat(rawCost).toFixed(2);
        }

        // Ensure total_students_for_ai-hidden and cost_per_student_for_ai-hidden are updated right before submit
        updateAllCostsAndDetails();

        // Check if at least one school is selected
        const selectedCheckboxes = document.querySelectorAll('input[name="schoolname"]:checked');
        if (selectedCheckboxes.length === 0) {
            alert("Please select at least one school.");
            event.preventDefault(); // Stop the form from submitting
            return;
        }

        generateBtn.style.display = 'none';
        loader.style.display = 'block';
    });

    // Event Listeners
    districtSelect.addEventListener('change', updateSchools);
    weeksInput.addEventListener('input', updateAllCostsAndDetails);
    daysInput.addEventListener('input', updateAllCostsAndDetails);

    // Initial Load
    document.addEventListener('DOMContentLoaded', updateSchools);
</script>

</body>
</html>